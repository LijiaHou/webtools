# 项目的难点
并不一定真的有多难，毕竟难度也是相对的，当面试官水平高于你时，你的难点对他来说都不算啥，所以面试官更多想要看的是面对问题的解决思路以及表达等等

所以要从需求背景、分析过程、压力来源（时间紧迫、历史遗留、三方难配合）、多个方案定制以及决策的思考过程

- 响应式布局vw
- 弹幕组件
  - 弹幕条数很大时会不会有性能问题
- 大列表渲染问题
- 代码检查 eslint 的使用
- ssr
- 跨域
- 性能优化

## 难点一：大列表渲染问题
### 背景
第一次出现是在表情包小程序里，首页要加载表情包列表，每行展示 3 个，每次请求 20 条数据，可以无限滚动，在一开始后台表情包数据还没那么多，还算正常，直到有一天产品找到我，说首页一直往后翻的话，会在某一个节点，整个页面都白屏，程序崩溃必须重启

### 分析
首先想的就是要定位问题，在开发者工具中去调试并没有出现白屏，但是手机上是可以复现，而且不同的手机出现的时间都不同，抓包后端的返回数据也是正常的，说明应该不是程序的语法或逻辑、数据出错，最后在开发者社区中搜到这个问题，原来是小程序的运行内存是有限制的，过多的 DOM 存在于页面导致超出内存从而崩溃

### 压力
产品还在探索阶段，虽然这个 bug 需要一定条件下才复现，可是是非常影响用户体验的，不及时搞可能会导致用户的流失

### 思考方案
- 既然问题是 DOM 过多导致，那我们可不可以做成分页的形式，翻页去浏览，与产品沟通，产品不想做翻页，而且 UI 的风格一开始就是这么设计的
- 没办法，google 搜索解决方案，了解到 虚拟列表的办法，监听滚动，只渲染窗口内以及周围的组件

### 解决过程
虽然没有了白屏的问题，但是仍然存在的问题：
- 如果滑的很快，还是会空白一会儿才能展示内容
  - 解决办法是使用骨架预填充
- 图片高度不固定怎么办

# 实际开发中遇到的问题
### 图片预加载
碰到gif或apng需要在同一个页面重复播放时，由于浏览器缓存机制，往往出现继续上一次的播放位置，而不是重新播，解决办法是给图片路径加上一个hash（？${Math.random()}），当然这里要使用cdn地址，另外还要在使用前预加载一下图片 new Image()

预加载方法：
- 使用 CSS 的 background-url ，但是要通过宽高或者定位来隐藏，不能用 display：none
- 使用 js 的 new Image()，给 src 赋值，通过监听 onload 事件来判断是否预加载完成

预加载的原理都是先在后台让图片的请求发出去，这样浏览器就会缓存到，等到真正用的时候就默认使用缓存，不需要请求了

### git提交文件夹名称
只修改了文件夹名的大小写时，是不会生成 git 提交的，但是由于本地的路径已经更新了，一不注意就会导致线上打包失败，但是线下时最新的代码却又没有问题的bug

# Koa图片工具
### 为什么选用这个方式来解决生成图片的问题
- 有些场景要求图片质量，这样图片比较大，再加上一些特殊字体文件，长期来看会占用比较多的主程序的体积
- 考虑到一些低端的机型性能问题，如果在前端生成可能会比较慢
- 因为图片合成涉及很多布局样式的问题，所以放在前端来维护比较方便


### 为什么选用Koa
- **轻量无捆绑**
  - koa把路由、静态服务、post请求的body解析等功能都从框架移除了，以中间件的方式引入。相比Express更加轻量、灵活、按需引入，同一个团队开发，是Express的轻量版。而egg是Express的豪华版
- api设计更加优雅
- Express中间件链是基于回调的。Koa则是基于Promise的，使用了**洋葱模型**，所有请求经过中间件都会执行两次，对比 Express 形式的中间件，Koa 模型方便处理后置逻辑，比如处理异常，只要放在其他中间件前面就可以捕获所有的错误了：

```js
async function onerror(ctx, next) {
  try {
    await next();
  } catch (err) {
    ctx.app.emit('error', err);
    ctx.body = 'server error';
    ctx.status = err.status || 500;
  }
}
```

- **Egg** 定位是**企业级**框架，基于Koa，做了一些增强和扩展，Express、Koa 定位是社区框架，相对Koa来说还是重了点 